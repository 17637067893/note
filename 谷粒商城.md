#### 软件搭建

1 虚拟机 

VirtualBox: https://download.virtualbox.org/virtualbox/6.0.10/VirtualBox-6.0.10-132072-Win.exe

2 Vagrant 

https://releases.hashicorp.com/vagrant/2.2.5/vagrant_2.2.5_x86_64.msi

 Vagrant 镜像仓库 https://app.vagrantup.com/boxes/search

3 安装好两个软件使用Vagrant给虚拟机创建镜像

![image-20210117104711356](G:\note\image\image-20210117104711356.png)

4 创建虚拟机

```
Vagrant init centos/7 //名字和镜像里一样可以创建一个Vagrantfile文件
```

![image-20210117105758949](G:\note\image\image-20210117105758949.png)

5 使用vagrant up 下载镜像和开启虚拟机

```
vagrant up //确保当前位置下有file文件
```

6 ![image-20210117110759459](G:\note\image\image-20210117110759459.png)

```
vagrant ssh  //连接虚拟机 
```

7给虚拟机指定ip

先查看网段为56

![image-20210117111624077](G:\note\image\image-20210117111624077.png)

![image-20210117111700033](G:\note\image\image-20210117111700033.png)

之后使用  vagrant reload  重启虚拟机

8 vagrant ssh 连接虚拟机  ip addr 查看ip 

![image-20210117111848191](G:\note\image\image-20210117111848191.png)

#### 安装docker

镜像容器

仓库地址 https://hub.docker.com/

安装步骤 https://docs.docker.com/engine/install/centos/

1 卸载之前的docker

```
sudo yum remove docker \
                  docker-client \
                  docker-client-latest \
                  docker-common \
                  docker-latest \
                  docker-latest-logrotate \
                  docker-logrotate \
                  docker-engine
```

2 设置地址

````
$ sudo yum install -y yum-utils

$ sudo yum-config-manager \
    --add-repo \
    https://download.docker.com/linux/centos/docker-ce.repo
````

3 安装

```
sudo yum install docker-ce docker-ce-cli containerd.io
```

报错 

```
requires containerd.io ＞= 1.4.1, but none of the providers can be installed
解决
dnf install https://download.docker.com/linux/centos/8/x86_64/stable/Packages/containerd.io-1.4.3-3.1.el8.x86_64.rpm
```



4 启动docker(先关闭防火墙)

```
sudo systemctl start docker
sudo systemctl enable docker
```

5 配置镜像加速(需要先登录阿里云)

https://cr.console.aliyun.com/cn-shanghai/instances/mirrors

```
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json <<-'EOF'
{
  "registry-mirrors": ["https://64dnk2wc.mirror.aliyuncs.com"]
}
EOF
sudo systemctl daemon-reload //重启docker后台线程
sudo systemctl restart docker
```

#### docker安装mysql

1 镜像仓库搜索mysql 根据tag选择

![image-20210117113939391](G:\note\image\image-20210117113939391.png)

2 sudo docker pull mysql:5.7  //冒号后跟tag

```
docker images 查看本地所有镜像
docker search 镜像名称 搜索镜像
docker pull 镜像名称 拉取镜像

docker rmi -f 镜像名称 删除镜像

```

容器 ：运行镜像就成了一个容器

```
docker run -i 镜像名称:标签 运行容器（默认是前台运行）
docker ps 查看运行的容器
docker ps -a 查询所有容器
docker exec -it mysql(容器名字或id) /bin/bash 进入容器内部

docker start 容器ID 
docker stop 容器ID

常用的参数：
-i：运行容器
-d：后台守方式运行（守护式）
--name：给容器添加名称
-p：3306:3306 端口映射
-v：挂载目录
```

3 运行mysql 挂载容器里的文件

![image-20210117121906838](G:\note\image\image-20210117121906838.png)

```
sudo docker run -p 3306:3306 --name mysql \
-v /mydata/mysql/log:/var/log/mysql \
-v /mydata/mysql/data:/var/lib/mysql \
-v /mydata/mysql/conf:/etc/mysql \
-e MYSQL_ROOT_PASSWORD=root \
-d mysql:5.7
端口映射
挂载日志
挂载配合
挂载文件夹
设置启动密码
docker update mysql(镜像名字) --restart=always  //启动docker时自动启动容器
如果容器启动出错
docker logs 容器ID  可以查看原因
```

运行成功之后可以使用docker ps查看运行的容器

使用navicat连接数据库查看

![image-20210117121655004](G:\note\image\image-20210117121655004.png)

4 更改mysql的配置文件

```
cd  /mydata/mysql/conf 进入到mysql本地挂载的配置文件 初次为空
vi my.cnf 创建配置文件
加入以下配置
[client]
default-character-set=utf8
[mysql]
default-character-set=utf8
[mysqld]
init_connect='SET collation_connection = utf8_unicode_ci'
init_connect='SET NAMES utf8'
character-set-server=utf8
collation-server=utf8_unicode_ci
skip-character-set-client-handshake
skip-name-resolve
```

4 docker restart mysql  重启mysql ![image-20210117123950942](G:\note\image\image-20210117123950942.png)

5 docker exec -it mysql /bin/bash  发现有my.cnf就配置成功了

#### docker 安装redis

1 docker pull redis //默认下载最新的

2 挂载文件

```
先创建配置文件
mkdir -p /mydata/redis/conf
touch /mydata/redis/conf/redis.conf
运行挂载目录
sudo docker run -p 6379:6379 --name redis -v /mydata/redis/data:/data -v /mydata/redis/conf/redis.conf:/etc/redis/redis.conf -d redis redis-server /etc/redis/redis.conf
```

 错误

```
如果已经运行这个名字的容器再次运行时会出错
docker: Error response from daemon: Conflict. The container name "/redis" is already in use by container "b7f72761bbcb95327d7b4be82c2cd961151dacf37280d80f8c1f8404ed8c4200". You have to remove (or rename) that container to be able to reuse that name.
解决
使用docker ps -a 查看运行的容器id
docker rm ID   删除容器
```

3 连接redis

![image-20210117130246767](G:\note\image\image-20210117130246767.png)

```
docker exec -it redis redis-cli
```

4 持久化  

此时redis的数据存在内存中 重启redis就没有了

进入映射的配置文件

![image-20210117130616218](G:\note\image\image-20210117130616218.png)

添加内容

![image-20210117130538769](G:\note\image\image-20210117130538769.png)

redis中存入值  set a bb

重启redis      docker restart redis

连接redis      docker exec -it redis redis-cli

获取值 依然可以获取的到

可以安装redis的可视化工具  redis desktop manager

开发环境

1 maven镜像该阿里云

```xml
 <mirrors>
    <mirror>
     <id>aliyunmaven</id>
     <mirrorOf>central</mirrorOf>
     <name>阿里云公共仓库</name>
     <url>https://maven.aliyun.com/repository/central</url>
    </mirror>
    <mirror>
      <id>repo1</id>
      <mirrorOf>central</mirrorOf>
      <name>central repo</name>
      <url>http://repo1.maven.org/maven2/</url>
    </mirror>
    <mirror>
     <id>aliyunmaven</id>
     <mirrorOf>apache snapshots</mirrorOf>
     <name>阿里云阿帕奇仓库</name>
     <url>https://maven.aliyun.com/repository/apache-snapshots</url>
    </mirror>
  </mirrors>
  <proxies/>
  <activeProfiles/>
  <profiles>
    <profile>  
        <repositories>
           <repository>
                <id>aliyunmaven</id>
                <name>aliyunmaven</name>
                <url>https://maven.aliyun.com/repository/public</url>
                <layout>default</layout>
                <releases>
                        <enabled>true</enabled>
                </releases>
                <snapshots>
                        <enabled>true</enabled>
                </snapshots>
            </repository>
            <repository>
                <id>MavenCentral</id>
                <url>http://repo1.maven.org/maven2/</url>
            </repository>
            <repository>
                <id>aliyunmavenApache</id>
                <url>https://maven.aliyun.com/repository/apache-snapshots</url>
            </repository>
        </repositories>             
     </profile>
  </profiles>
```

2 jdk改为1.8

```xml
<profile>   
    <id>jdk-1.8</id>   
     <activation>   
          <activeByDefault>true</activeByDefault>   
          <jdk>1.8</jdk>   
      </activation>   
    <properties>   
    <maven.compiler.source>1.8</maven.compiler.source>   
    <maven.compiler.target>1.8</maven.compiler.target>   
    <maven.compiler.compilerVersion>1.8</maven.compiler.compilerVersion>   
    </properties>
</profile>
```

3 vscode 安装插件

![image-20210117135031103](G:\note\image\image-20210117135031103.png)

4 github上创建项目 clone下来用IDEA打开

1 创建微服务项目

商品服务 仓库服务 订单服务 优惠券服务 用户服务

1 每个服务选择web openfeign

2 包名 com.atguigu.gulimall.xx(product/order/ware/coupon/member)

3 模块名 gulimall-coupon

![image-20210117141911687](G:\note\image\image-20210117141911687.png)

选择依赖

![image-20210117142451633](G:\note\image\image-20210117142451633.png)

![image-20210117142527644](G:\note\image\image-20210117142527644.png)

#### 创建数据库

![image-20210117164653885](G:\note\image\image-20210117164653885.png)

每个选择一下配置

![image-20210117164526194](G:\note\image\image-20210117164526194.png)

用对应的sql文件在库中创建相应的表

![image-20210117165059179](C:\Users\gg\AppData\Roaming\Typora\typora-user-images\image-20210117165059179.png)

#### 整合项目

https://gitee.com/renrenio 删除其中的.git文件

1 下载人人开源 fast(前端) fast-vue(后端)

2 更改其中的数据库

3 加载全部依赖   启动项目

![image-20210117194249987](G:\note\image\image-20210117194249987.png)

4 下载代码生成器工程 https://gitee.com/renrenio/renren-generator

1修改数据库配置

![image-20210117195044400](G:\note\image\image-20210117195044400.png)

2 修改代码生成器配置

![image-20210117194707606](C:\Users\gg\AppData\Roaming\Typora\typora-user-images\image-20210117194707606.png)

#### SpringCloudAlibaba

#### 服务注册

![image-20210117221638730](G:\note\image\image-20210117221638730.png)

1 安装nacos 

2 每个微服务注册进nacos

1 公共模块引入依赖

```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>
```

2 添加配置

```
cloud:
    nacos:
      discovery:
        server-addr: localhost:8848 #配置Nacos地址
  application:
    name: gulimall-order  //每个服务写自己的名字
```

3 主启动类添加   @EnableDiscoveryClient

服务间调用

1 安装依赖

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-openfeign</artifactId>
</dependency>
```

2 主启动类添加注解 

```java
@SpringBootApplication
@EnableDiscoveryClient
@EnableFeignClients(basePackages = "com.atguigu.gulimall.member.feign")
public class GulimallMemberApplication {

	public static void main(String[] args) {
		SpringApplication.run(GulimallMemberApplication.class, args);
	}

}
```

3 编写接口

```java
@Service
@FeignClient("gulimall-coupon") //注册中心服务的名称
public interface CouponFeignService {

    @GetMapping("coupon/coupon/test") //调用接口的全部路径
    public R testMessage();
}
```

4 controller调用

```java
@Resource
private CouponFeignService couponFeignService;

@GetMapping("testFeign")
public R get(){
    R r = couponFeignService.testMessage();
    return r;
}
```

递归获取树形列表

```java
public List<CategoryEntity> listWithTree() {
    //查出所有分类
    List<CategoryEntity> entities = baseMapper.selectList(null);
    //获取所有的一级分类
    List<CategoryEntity> collect = entities.stream()
        .filter((categoryEntity -> categoryEntity.getParentCid() == 0))
        .map((menu)->{menu.setChildren(getChildrens(menu,entities)); return menu;})
        .sorted((menu1,menu2)->{
            return (menu1.getSort() == null? 0 :menu1.getSort()) - (menu2.getSort() == null? 0 :menu2.getSort());
        })
        .collect(Collectors.toList());
    //组装树形分类
    return collect;
}
//
private List<CategoryEntity> getChildrens(CategoryEntity root,List<CategoryEntity> all){
    List<CategoryEntity> children = all.stream().filter(categoryEntity ->{
        return categoryEntity.getParentCid() == root.getCatId();
    }).map(categoryEntity->{
        categoryEntity.setChildren(getChildrens(categoryEntity,all));
        return categoryEntity;
    }).sorted((menu1,menu2)->{
        return (menu1.getSort() == null? 0 :menu1.getSort()) - (menu2.getSort() == null? 0 :menu2.getSort());
    }).collect(Collectors.toList());
    return children;
}
```



解决跨域

![image-20210118214052391](G:\note\image\image-20210118214052391.png)



![image-20210118214245660](G:\note\image\image-20210118214245660.png)

#### 网关解决跨域

```java
@Configuration
public class GulimallCorsConfig{
    @Bean
    public CorsWebFilter corsWebFilter(){
        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        CorsConfiguration corsConfiguration = new CorsConfiguration();
        corsConfiguration.addAllowedHeader("*");
        corsConfiguration.addAllowedMethod("*");
        corsConfiguration.addAllowedOrigin("*");
        corsConfiguration.setAllowCredentials(true);

        source.registerCorsConfiguration("/**",corsConfiguration);
        return new CorsWebFilter(source);
    }
}
```

枚举常量

1 新建类

```java
package com.atguigu.common.constant;


public class ProductConstant {
    public enum AttrEnum{
        ATTR_TYPE_BASE(1,"基本属性"),ATTR_TYPE_SALE(0,"销售属性");
        private int code;
        private String msg;

        AttrEnum(int code,String msg){
            this.code = code;
            this.msg = msg;
        }

        public int getCode(){
            return code;
        }

        public String getMsg(){
            return msg;
        }
    }
}

```

2 使用方法

```java
QueryWrapper<AttrEntity> queryWrapper= new QueryWrapper<AttrEntity>()
    .eq("attr_type","base".equalsIgnoreCase(type)? ProductConstant.AttrEnum.ATTR_TYPE_BASE.getCode():ProductConstant.AttrEnum.ATTR_TYPE_SALE.getCode());
```

#### Elasticsearch

快速检索

![image-20210121113006306](G:\note\image\image-20210121113006306.png)

###### 倒排索引

![image-20210121113026366](G:\note\image\image-20210121113026366.png)

###### docker中安装 Elasticsearch

1 安装

```
docker pull elasticsearch:7.4.2  //下载镜像
docker pull kibana:7.4.2  //可视化检索

挂载配置
1创建挂载目录
mkdir -p /mydata/elasticsearch/config
mkdir -p /mydata/elasticsearch/data
2 开启远程访问
/mydata/elasticsearch/config/elasticsearch.yml
network.host: 0.0.0.0  #改为0.0.0.0对外开放，如对特定ip开放则改为指定ip
http.port: 9200      #可更改端口不为9200
echo "http.host:0.0.0.0">>/mydata/elasticsearch/config/elasticsearch.yml

3 运行

docker run --name elasticsearch -p 9200:9200 -p 9300:9300 \
-e "discovery.type=single-node" \
-e ES_JAVA_OPTS="-Xms64m -Xmx128m" \
-v /mydata/elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml \
-v /mydata/elasticsearch/data:/usr/share/elasticsearch/data \
-v /mydata/elasticsearch/plugins:/usr/share/elasticsearch/plugins \
-d elasticsearch:7.4.2

更改权限
chmod -R 777 /mydata/elasticsearch  更改所有人都可读写执行
docker logs elasticsearch //查看运行日志


4 Kibana
docker run --name kibana -e ELASTICSEARCH_HOSTS=http://192.168.111.133:9200/ -p 5601:5601 \
-d kibana:7.4.2
```

更改当前索引修改数据

```
PUT http://127.0.0.1:9200/索引名称/_settings
{
"index.blocks.read_only_allow_delete": null
}
```



#### 初步检索

1 _cat

```
 GET/_cat/nodes:  查看所有节点
 GET/_cat/health: 查看健康状况
  GET/_cat/master: 查看主节点
   GET/_cat/indices: 查看所有索引
```

2 保存数据

```
http:ip:9200/索引/类型/数据名
发送请求

put请求保存
http:192.168.56.10:9200/customer/externam/1  //再次发送 如果数据名已经有了就位update
{
  "name":"小明"
}


post请求
不带id就是新增随机产生id  再次发送 如果数据名已经有了就位update
http:192.168.56.10:9200/customer/externam
http:192.168.56.10:9200/customer/externam/1if_seq_no=1&if_primary_term=1 //带乐观锁修改
{
  "name":"小明"
}
```

3 查询数据

```
http:ip:9200/索引/类型/数据名   get请求

{
  "_index":"customer"  //索引
  "_type":"external"  // 类型
  "_id":"1"           //数据标识
  "_version":2,       //版本号
  "_seq_no":1,        //乐观锁
  "_primary_term":1,  //主分片重新分配
  "found":true,       //是否有数据
  "_source":{         //数据内容
    "name":"小明"  
  }
}
```

4 更新数据

```
POST customer/external/1/_update   //会对比原来数据  如果数据一样 就不改变数 version不变
{
    "doc":{
      "name":"小明",
      "age":20
    }
}
或者带Id标识的   put post请求
```

5 查询

```
DELETE customer/external/1  //删除数据
DELETE customer//删除索引
```

#### kibana

http://192.168.111.133:5601

![image-20210121165641095](G:\note\image\image-20210121165641095.png)

```
POST /customer/externam/_bulk
{"index":{"_id":"1"}}
{"name":"这是第一个"}
{"index":{"_id":"2"}}
{"name":"这是第2个"}
{"index":{"_id":"3"}}
{"name":"这是第3个"}

POST _bulk
{"delete":{"_index":"website","_type":"blog","_id":"123"}}
{"create":{"_index":"website","_type":"blog","_id":"123"}}  //如果和原来的数据一样 版本号不会添加 序列号也不加
{"title":"MY first blog post"}
{"index":{"_index":"website","_type":"blog","_id":"123"}}  //保存
{"title":"My second blog post"}
{"update":{"_index":"website","_type":"blog","_id":"123"}}
{"doc":{"title":"My update blog post"}}
```

测试数据  https://github.com/elastic/elasticsearch/blob/master/docs/src/test/resources/accounts.json

保存测试数据

```
POST /bank/account/_bulk
{"index":{"_id":"1"}}
```

#### 进阶检索

基本检索

1 条件检索 条件封装在uri中

![image-20210121173004371](G:\note\image\image-20210121173004371.png)

```
GET bank/_search?q=*&sort=account_number:asc
```

2 条件在请求体里 Query DSL

```
GET bank/_search
{
  "query": { "match_all": {} },  //插叙条件
  "sort": [
    { "account_number": "asc" },  //排序条件
  ]
}
```

3 查询全部范围

```
GET bank/_search
{
  "query": { "match_all": {} },  //查询全部条件
  "sort": [
    {
      "balance": {
        "order": "asc"   // balance字段 升序
      }
    }
  ],
  "from": 0,    //从0 到5 五条数据
  "size": 5,
  "_source": ["balance","firstname","age"]  //自定义返回的字段
}



```

#### match查询 

指定字段名匹配

4 如果属性为数字精确插叙

```

    GET bank/_search
    {
      "query": {"match": {
        "account_number": "20"
      }}
    }
    
    {
  "took" : 178,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 1,
      "relation" : "eq"
    },
    "max_score" : 1.0,
    "hits" : [
      {
        "_index" : "bank",
        "_type" : "account",
        "_id" : "20",
        "_score" : 1.0,
        "_source" : {
          "account_number" : 20,
          "balance" : 16418,
          "firstname" : "Elinor",
          "lastname" : "Ratliff",
          "age" : 36,
          "gender" : "M",
          "address" : "282 Kings Place",
          "employer" : "Scentric",
          "email" : "elinorratliff@scentric.com",
          "city" : "Ribera",
          "state" : "WA"
        }
      }
    ]
  }
}
```

5 如果属性为字符串 为模糊查询

```
GET bank/_search
{
  "query": {"match": {
    "address": "Kings" //进行分词匹配
  }}
}

{
  "took" : 52,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 2,
      "relation" : "eq"
    },
    "max_score" : 5.9908285,
    "hits" : [
      {
        "_index" : "bank",
        "_type" : "account",
        "_id" : "20",
        "_score" : 5.9908285,
        "_source" : {
          "account_number" : 20,
          "balance" : 16418,
          "firstname" : "Elinor",
          "lastname" : "Ratliff",
          "age" : 36,
          "gender" : "M",
          "address" : "282 Kings Place",
          "employer" : "Scentric",
          "email" : "elinorratliff@scentric.com",
          "city" : "Ribera",
          "state" : "WA"
        }
      },
      {
        "_index" : "bank",
        "_type" : "account",
        "_id" : "722",
        "_score" : 5.9908285,
        "_source" : {
          "account_number" : 722,
          "balance" : 27256,
          "firstname" : "Roberts",
          "lastname" : "Beasley",
          "age" : 34,
          "gender" : "F",
          "address" : "305 Kings Hwy",
          "employer" : "Quintity",
          "email" : "robertsbeasley@quintity.com",
          "city" : "Hayden",
          "state" : "PA"
        }
      }
    ]
  }
}

```

5 完整短语匹配match_phrase

```
GET bank/_search
{
  "query": {
    "match_phrase": {
      "address": "mill lan",  //只会匹配包含 mill lan 如果match会进行分词匹配 包含两个单词都会返回
      address.keyword": "mill lan"  //值定于 不是包含mill lan
    }
  }
}
```

6  multi_match 多字段匹配

```
GET bank/_search
{
 "query":{
    "multi_match":{
      "query":"mill movice",  //分词检索
      "fields":["state","address"]  //两个字段里包含mill的都返回
    }
 }
}
```

6 query->bool    must must_not

```

GET bank/_search
{
  "query": {
    "bool": {
      "must": [
        {"match": {
          "gender": "M"
        }},
        {
          "match": {
            "address": "mill"
          }
        }
      ],
      "must_not": [
        {"match": {
          "age": "38"
        }}
      ],
      "should": [
        {"match": {
          "lastname": "Wallace"
        }}
      ],
      "filter": {  //与match功能相似 但是匹配到不贡献得分
        "range": {
          "age": {
            "gte": 10,
            "lte": 30
          }
        }
      }
    }
  }
}
```

7 term

```
GET bank/_search
{
  "query": {
    "term": {
      "age": {
        "value": 20   //字段值等于20 并不是包含
      }
    }
  }
}
```

#### 聚合统计

1 所有人聚合统计

```
GET bank/_search
{
  "query": {
    "match": {
      "address": "mill"
    }
  },
  "aggs": {
    "ageAgg": {   //自定义聚合名字
      "terms": {   //条件
        "field": "age",
        "size": 10
      }
    },
   "ageAvg": {   
        "avg": {  // 所有人求平均值
          "field": "balance"
        }
      }
  }
}
```

2 查出条件内 在进行聚合统计

```
GET bank/_search
{
  "query": {
    "match_all": {}
  },
  "aggs": {
    "ageAgg": {
      "terms": {
        "field": "age",
        "size": 10
      },
      "aggs":{  //每个age分组内在进行 求平均值
        "ageAvg":{
          "avg": {
            "field": "balance"
          }
        }
      }
    }
  }
}

结果分析
"aggregations" : {
    "ageAgg" : {
      "doc_count_error_upper_bound" : 0,
      "sum_other_doc_count" : 463,
      "buckets" : [
        {
          "key" : 31,  //age =31的有 61人
          "doc_count" : 61,
          "ageAvg" : {
            "value" : 28312.918032786885  //平均值为
          }
        },
        {
          "key" : 39,
          "doc_count" : 60,
          "ageAvg" : {
            "value" : 25269.583333333332
          }
        },
        {
          "key" : 26,
          "doc_count" : 59,
          "ageAvg" : {
            "value" : 23194.813559322032
          }
        }
      ]
    }
  }

```

4 根据年龄聚合

```
GET bank/_search
{
  "query": {"match_all": {}},
  "aggs": {
    "ageAgg": { 根据年龄聚合
      "terms": {
        "field": "age",
        "size": 10
      },
      "aggs": {
        "genderAgg": { //再根据性别聚合
          "terms": {
            "field": "gender.keyword",
            "size": 10
          },
          "aggs": {  // 再查出平均值
            "avgAgg": {
              "avg": {
                "field": "balance"
              }
            }
          }
        }
      }
    }
  }
}

```

###### mapping 存储的数据类型

```
GET /bank/_mapping
结果
{
  "bank" : {
    "mappings" : {
      "properties" : {
        "account_number" : {
          "type" : "long"
        },
        "address" : {
          "type" : "text",
          "fields" : {
            "keyword" : {
              "type" : "keyword",
              "ignore_above" : 256
            }
          }
        },
        "age" : {
          "type" : "long"
        },
        "balance" : {
          "type" : "long"
        },
        "city" : {
          "type" : "text",
          "fields" : {
            "keyword" : {
              "type" : "keyword",
              "ignore_above" : 256
            }
          }
        },
        "email" : {
          "type" : "text",
          "fields" : {
            "keyword" : {
              "type" : "keyword",
              "ignore_above" : 256
            }
          }
        },
        "employer" : {
          "type" : "text",
          "fields" : {
            "keyword" : {
              "type" : "keyword",
              "ignore_above" : 256
            }
          }
        },
        "firstname" : {
          "type" : "text",
          "fields" : {
            "keyword" : {
              "type" : "keyword",
              "ignore_above" : 256
            }
          }
        },
        "gender" : {
          "type" : "text",
          "fields" : {
            "keyword" : {
              "type" : "keyword",
              "ignore_above" : 256
            }
          }
        },
        "lastname" : {
          "type" : "text",
          "fields" : {
            "keyword" : {
              "type" : "keyword",
              "ignore_above" : 256
            }
          }
        },
        "state" : {
          "type" : "text",
          "fields" : {
            "keyword" : {
              "type" : "keyword",
              "ignore_above" : 256
            }
          }
        }
      }
    }
  }
}
```

创建映射

```
# 创建数据前先指定类型
PUT /my_index
{
  "mappings": {
    "properties": {
      "age":{"type": "integer"},
      "email":{"type": "keyword"},
      "name":{"type": "text"}
    }
  }
}
获取映射
PUT /my_index/_mapping

添加字段的数据类型
PUT /my_index/_mapping
{
  "properties":{
    "employee_id":{
      "type":"keyword", 
      "index":false
    }
  }
}
```

修改mapping  已经存在的字段不能修改类。只能做数据迁移

1 新建mapping

```
PUT newbank
{
  "mappings": {
    "properties": {
          "account_number" : {
          "type" : "integer"
        },
        "address" : {
          "type" : "text"
        },
        "age" : {
          "type" : "integer"
        },
        "balance" : {
          "type" : "integer"
        },
        "city" : {
          "type" : "text"
        },
        "email" : {
          "type" : "keyword"
        },
        "employer" : {
          "type" : "keyword"
        },
        "firstname" : {
          "type" : "text"
        },
        "gender" : {
          "type" : "keyword"
        },
        "lastname" : {
          "type" : "text"
        },
        "state" : {
          "type" : "keyword"
        }
    }
  }
}
```

2 数据迁移

```
POST _reindex
{
  "source": {
    "index": "bank",
    "type": "account"
  },
  "dest": {
    "index": "newbank"
  }
}
```

###### 分词器  

将我们的一句话拆分成多个部分，

```
POST _analyze
{
  "analyzer": "standard",
  "text": "尚硅谷电商项目"
}

结果
{
  "tokens" : [
    {
      "token" : "尚",
      "start_offset" : 0,
      "end_offset" : 1,
      "type" : "<IDEOGRAPHIC>",
      "position" : 0
    },
    {
      "token" : "硅",
      "start_offset" : 1,
      "end_offset" : 2,
      "type" : "<IDEOGRAPHIC>",
      "position" : 1
    },
    {
      "token" : "谷",
      "start_offset" : 2,
      "end_offset" : 3,
      "type" : "<IDEOGRAPHIC>",
      "position" : 2
    },
    {
      "token" : "电",
      "start_offset" : 3,
      "end_offset" : 4,
      "type" : "<IDEOGRAPHIC>",
      "position" : 3
    },
    {
      "token" : "商",
      "start_offset" : 4,
      "end_offset" : 5,
      "type" : "<IDEOGRAPHIC>",
      "position" : 4
    },
    {
      "token" : "项",
      "start_offset" : 5,
      "end_offset" : 6,
      "type" : "<IDEOGRAPHIC>",
      "position" : 5
    },
    {
      "token" : "目",
      "start_offset" : 6,
      "end_offset" : 7,
      "type" : "<IDEOGRAPHIC>",
      "position" : 6
    }
  ]
}

```

ik分词器 对中文友好

1 下载分词器

```
https://github.com/medcl/elasticsearch-analysis-ik
```

2 在映射的

```
/mydata/elasticsearch/plugins/ik 重启es
```

3 使用

ik_smart

```
POST _analyze
{
  "analyzer": "ik_smart",
  "text": "尚硅谷电商项目"
}

只能分词
{
  "tokens" : [
    {
      "token" : "尚",
      "start_offset" : 0,
      "end_offset" : 1,
      "type" : "CN_CHAR",
      "position" : 0
    },
    {
      "token" : "硅谷",
      "start_offset" : 1,
      "end_offset" : 3,
      "type" : "CN_WORD",
      "position" : 1
    },
    {
      "token" : "电",
      "start_offset" : 3,
      "end_offset" : 4,
      "type" : "CN_CHAR",
      "position" : 2
    },
    {
      "token" : "商",
      "start_offset" : 4,
      "end_offset" : 5,
      "type" : "CN_CHAR",
      "position" : 3
    },
    {
      "token" : "项目",
      "start_offset" : 5,
      "end_offset" : 7,
      "type" : "CN_WORD",
      "position" : 4
    }
  ]
}
```

ik_max_word

```
POST _analyze
{
  "analyzer": "ik_max_word",
  "text": "我是中国人"
}

{
  "tokens" : [
    {
      "token" : "我",
      "start_offset" : 0,
      "end_offset" : 1,
      "type" : "CN_CHAR",
      "position" : 0
    },
    {
      "token" : "是",
      "start_offset" : 1,
      "end_offset" : 2,
      "type" : "CN_CHAR",
      "position" : 1
    },
    {
      "token" : "中国人",
      "start_offset" : 2,
      "end_offset" : 5,
      "type" : "CN_WORD",
      "position" : 2
    },
    {
      "token" : "中国",
      "start_offset" : 2,
      "end_offset" : 4,
      "type" : "CN_WORD",
      "position" : 3
    },
    {
      "token" : "国人",
      "start_offset" : 3,
      "end_offset" : 5,
      "type" : "CN_WORD",
      "position" : 4
    }
  ]
}

```

